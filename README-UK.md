# UFO Event Sourcing

–õ–µ–≥–∫–∞ —Ç–∞ —Å—É—á–∞—Å–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ Event Sourcing –¥–ª—è PHP 8.3+

---

## üöÄ –û—Å–Ω–æ–≤–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ

* –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–æ–º–µ–Ω–Ω–∏—Ö –ø–æ–¥—ñ–π –∑–∞–º—ñ—Å—Ç—å –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É
* –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–≥—Ä–µ–≥–∞—Ç—ñ–≤ —á–µ—Ä–µ–∑ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ–¥—ñ–π (replay)
* –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –ø—Ä–æ—î–∫—Ü—ñ–π –¥–ª—è –ø–æ–±—É–¥–æ–≤–∏ read-–º–æ–¥–µ–ª–µ–π
* –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–∏—Ö event store —Ç–∞ –¥–∏—Å–ø–µ—Ç—á–µ—Ä—ñ–≤

---

## üìñ –û—Å–Ω–æ–≤–Ω—ñ –∫–æ–Ω—Ü–µ–ø—Ü—ñ—ó

* **Resolver** ‚Äî –º–æ–¥—É–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∑–º—ñ–Ω –º—ñ–∂ —Å—Ç–∞—Ä–∏–º —ñ –Ω–æ–≤–∏–º —Å—Ç–∞–Ω–æ–º.
* **Restorer** ‚Äî –º–æ–¥—É–ª—å –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –æ–±‚Äô—î–∫—Ç–∞ —ñ–∑ –∑–º—ñ–Ω.
* **Merger** ‚Äî —Å–µ—Ä–≤—ñ—Å –¥–ª—è –ø–æ–µ—Ç–∞–ø–Ω–æ–≥–æ –Ω–∞–∫–ª–∞–¥–µ–Ω–Ω—è –∑–º—ñ–Ω –Ω–∞ –æ–±‚Äô—î–∫—Ç.
* **ContextDTO** ‚Äî DTO –¥–ª—è –ø–µ—Ä–µ–¥–∞—á—ñ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –ø—ñ–¥ —á–∞—Å –∞–Ω–∞–ª—ñ–∑—É –∑–º—ñ–Ω (—à–ª—è—Ö, —Ç–∏–ø –∫–æ–ª–µ–∫—Ü—ñ—ó, –∞—Ç—Ä–∏–±—É—Ç–∏).
* **Attributes** ‚Äî PHP 8.3 –∞—Ç—Ä–∏–±—É—Ç–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–æ–≤–µ–¥—ñ–Ω–∫–æ—é –∞–Ω–∞–ª—ñ–∑—É –∑–º—ñ–Ω.

---

## üõ† –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è

```bash
composer require ufo-tech/event-sourcing
```

---

## üì¶ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

### Resolver

| –ö–ª–∞—Å                 | –û–ø–∏—Å                                             |
| -------------------- | ------------------------------------------------ |
| `MainResolver`       | –î–µ–ª–µ–≥—É—î –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∑–º—ñ–Ω –¥–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ–≥–æ resolver |
| `ObjectResolver`     | –ü—Ä–∞—Ü—é—î –∑ –æ–±‚Äô—î–∫—Ç–∞–º–∏ —á–µ—Ä–µ–∑ Reflection API          |
| `CollectionResolver` | –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –∞—Å–æ—Ü—ñ–∞—Ç–∏–≤–Ω–∏—Ö –º–∞—Å–∏–≤—ñ–≤                   |
| `ArrayResolver`      | –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –ø—Ä–æ—Å—Ç–∏—Ö —Å–ø–∏—Å–∫—ñ–≤                        |
| `ScalarResolver`     | –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —Å–∫–∞–ª—è—Ä–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å                     |

### Restorer & Merger

| –ö–ª–∞—Å               | –û–ø–∏—Å                                                    |
| ------------------ | ------------------------------------------------------- |
| `Merger`           | –ù–∞–∫–ª–∞–¥–∞—î –∑–º—ñ–Ω–∏ –Ω–∞ –±–∞–∑–æ–≤–∏–π —Å—Ç–∞–Ω                          |
| `ObjectRestorer`   | –í—ñ–¥–Ω–æ–≤–ª—é—î –æ–±‚Äô—î–∫—Ç –∑ –∫–æ–ª–µ–∫—Ü—ñ—ó –∑–º—ñ–Ω —á–µ—Ä–µ–∑ `DTOTransformer` |
| `ObjectDefinition` | –û–ø–∏—Å—É—î —Ç–∏–ø –æ–±'—î–∫—Ç–∞ –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ —ñ—Å—Ç–æ—Ä—ñ—ó –∑–º—ñ–Ω       |

### –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∏

| –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å                      | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è                              |
| ------------------------------ | ---------------------------------------- |
| `ResolverInterface`            | –ü–æ—à—É–∫ –∑–º—ñ–Ω –º—ñ–∂ —Å—Ç–∞–Ω–∞–º–∏                   |
| `MergerInterface`              | –ù–∞–∫–ª–∞–¥–∞–Ω–Ω—è –∑–º—ñ–Ω –Ω–∞ —Å—Ç–∞–Ω                  |
| `RestorerInterface`            | –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –æ–±'—î–∫—Ç–∞ –∑ —ñ—Å—Ç–æ—Ä—ñ—ó –∑–º—ñ–Ω       |
| `MainResolverInterface`        | –Ü–Ω–∫–∞–ø—Å—É–ª—è—Ü—ñ—è –¥–µ–∫—ñ–ª—å–∫–æ—Ö resolver          |
| `MainResolverFactoryInterface` | –§–∞–±—Ä–∏–∫–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –≥–æ–ª–æ–≤–Ω–æ–≥–æ resolver |

---

## üü† –ê—Ç—Ä–∏–±—É—Ç–∏

| –ê—Ç—Ä–∏–±—É—Ç           | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è                           |
| ----------------- | ------------------------------------- |
| `#[ChangeIgnore]` | –Ü–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è –ø–æ–ª—è –ø—Ä–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –∑–º—ñ–Ω  |
| `#[AsCollection]` | –í–∫–∞–∑—É—î, —â–æ –ø–æ–ª–µ —î –∫–æ–ª–µ–∫—Ü—ñ—î—é –∑ –∫–ª—é—á–∞–º–∏ |

---

## üü¢ –ö–æ–Ω—Ç–µ–∫—Å—Ç–∏

`ContextDTO` –¥–æ–∑–≤–æ–ª—è—î –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—ñ–¥ —á–∞—Å resolve:

* –ü–æ—Ç–æ—á–Ω–∏–π —à–ª—è—Ö (path)
* –¢–∏–ø (collection/array/scalar)
* –°–ø–µ—Ü–ø—Ä–∞–ø–æ—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—è (`__DELETED__`)
* –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –≤–∫–ª–∞–¥–µ–Ω–∏—Ö —à–ª—è—Ö—ñ–≤ –ø—Ä–∏ —Ä–æ–±–æ—Ç—ñ –∑ –æ–±‚Äô—î–∫—Ç–∞–º–∏ —Ç–∞ –∫–æ–ª–µ–∫—Ü—ñ—è–º–∏

### –ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è ContextDTO

* `ContextDTO::create()` —Å—Ç–≤–æ—Ä—é—î –±–∞–∑–æ–≤–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑ –∫–æ—Ä–µ–Ω–µ–≤–∏–º —à–ª—è—Ö–æ–º `root`.
* `forPath(string $param)` —Å—Ç–≤–æ—Ä—é—î –Ω–æ–≤–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —ñ–∑ –¥–æ–¥–∞–≤–∞–Ω–Ω—è–º —à–ª—è—Ö—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `root.products`).
* `makeAssocByPath(string $path)` –ø–æ–∑–Ω–∞—á–∞—î —à–ª—è—Ö —è–∫ –∞—Å–æ—Ü—ñ–∞—Ç–∏–≤–Ω–∏–π ‚Äî –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `products` –∞–±–æ –≤–∫–ª–∞–¥–µ–Ω—ñ `root.products.*`.
* –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —à–∞–±–ª–æ–Ω–Ω–∏—Ö —à–ª—è—Ö—ñ–≤ —ñ–∑ —Å–∏–º–≤–æ–ª–æ–º `$`, —è–∫–∏–π –±—É–¥–µ –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤–∞–Ω–∏–π —É –ø–∞—Ç–µ—Ä–Ω `*` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∫–æ–ª–µ–∫—Ü—ñ–π–Ω–∏—Ö –ø–æ–ª—ñ–≤ –Ω–∞ –≤–∫–ª–∞–¥–µ–Ω–∏—Ö —Ä—ñ–≤–Ω—è—Ö.
* –°–ø–µ—Ü–ø—Ä–∞–ø–æ—Ä –≤–∏–¥–∞–ª–µ–Ω–Ω—è –º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏ —á–µ—Ä–µ–∑ `ContextDTO::create(deletePlaceholder: '__DELETED__')`.

#### –ü—Ä–∏–∫–ª–∞–¥–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è ContextDTO:

```php
use Ufo\EventSourcing\Resolver\ContextDTO;

// –æ–¥–∏–Ω —à–ª—è—Ö
$context = new ContextDTO(assocPaths: ['products']);
$context = new ContextDTO(assocPaths: 'products');

// –¥–µ–∫—ñ–ª—å–∫–∞ —à–ª—è—Ö—ñ–≤
$context = new ContextDTO(assocPaths: ['products', 'items.subitems']);

// –∑ –∫–∞—Å—Ç–æ–º–Ω–∏–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–º –≤–∏–¥–∞–ª–µ–Ω–Ω—è
$context = new ContextDTO(deletePlaceholder: '__DELETED__', assocPaths: ['products']);
```

#### –î–ª—è –∫–æ–ª–µ–∫—Ü—ñ–π –∑—ñ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∏–º–∏ –∫–ª—é—á–∞–º–∏ –∞–±–æ —à–∞–±–ª–æ–Ω–∞–º–∏:

```php
// –í—Å—ñ subitems —É –±—É–¥—å-—è–∫–∏—Ö items –º–∞—é—Ç—å —Å–ø—Ä–∏–π–º–∞—Ç–∏—Å—å —è–∫ –∫–æ–ª–µ–∫—Ü—ñ—ó
$context = ContextDTO::create()
    ->makeAssocByPath('items.$.subitems');

// products.*.discounts.*.details ‚Äî –∞—Å–æ—Ü—ñ–∞—Ç–∏–≤–Ω—ñ details –≤ —É—Å—ñ—Ö discounts –≤ —É—Å—ñ—Ö products
$context = ContextDTO::create()
    ->makeAssocByPath('products.$.discounts.$.details');

// –î–ª—è –∫–æ–ª–µ–∫—Ü—ñ—ó –Ω–∞ –≤–µ—Ä—Ö–Ω—å–æ–º—É —Ä—ñ–≤–Ω—ñ (root)
$context = ContextDTO::create(assocPaths: ['']);
```

üìù –ü—Ä–∏–º—ñ—Ç–∫–∞:

–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `$` –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –≤ –ø–∞—Ç–µ—Ä–Ω `*`, —ñ –ø–æ—à—É–∫ –∫–æ–ª–µ–∫—Ü—ñ–π –≤–∏–∑–Ω–∞—á–∞—î—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —à–ª—è—Ö—É.

---

## üìù –ü—Ä–∏–∫–ª–∞–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### –ü–æ—à—É–∫ –∑–º—ñ–Ω

```php
$mainResolver = (new DefaultResolverFactory())->create();
$diff = $mainResolver->resolve($oldObject, $newObject);
```

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –∑ –∞—Å–æ—Ü—ñ–∞—Ç–∏–≤–Ω–æ—é –∫–æ–ª–µ–∫—Ü—ñ—î—é

```php

$context = ContextDTO::create(assocPath: 'products');
$diff = $mainResolver->resolve($old, $new, $context);

// –∞–±–æ
$context = ContextDTO::create()->makeAssocByPath('products');
$diff = $mainResolver->resolve($old, $new, $context);
```

### –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –æ–±'—î–∫—Ç–∞ –∑ —ñ—Å—Ç–æ—Ä—ñ—ó –∑–º—ñ–Ω

```php
$restorer = new ObjectRestorer(new Merger());
$restored = $restorer->restore(
    (new ObjectDefinition(MyDto::class))
        ->addChanges($firstChange)
        ->addChanges($secondChange)
);
```

---

## üìö –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è

* Event Sourcing —Ç–∞ CQRS-–∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏
* –ü—Ä–æ—î–∫—Ç–∏ –∑ DDD-–ø—ñ–¥—Ö–æ–¥–æ–º
* –°–µ—Ä–≤—ñ—Å–Ω–æ-–æ—Ä—ñ—î–Ω—Ç–æ–≤–∞–Ω—ñ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ –∑ –ø–æ–¥—ñ—î–≤–∏–º –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è–º

---

## üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

–î–µ—Ç–∞–ª—å–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è –±—É–¥–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ [docs.ufo-tech.space](https://docs.ufo-tech.space/bin/view/docs/EventSourcing/?language=en)

---

## üìú –õ—ñ—Ü–µ–Ω–∑—ñ—è

MIT ¬© [UFO Tech](https://ufo-tech.space)
